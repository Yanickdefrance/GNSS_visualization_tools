# Tampere University of Technology
#
# DESCRIPTION
# Read data from ublox
#
# AUTHOR
# Anne-Marie Tobie

# import connection
import serial
import time


def init_ublox(com):
    # sets initial values into the device
    baud_rate = 9600
    data_bits = 8
    parity = 'N'
    stop_bit = 1
    timeout = 1
    device = serial.Serial(com, timeout=timeout, stopbits=stop_bit, write_timeout=None,
                           bytesize=data_bits, rtscts=False, xonxoff=False, parity=parity,
                           baudrate=baud_rate, inter_byte_timeout=None, dsrdtr=False)
    return device


def reset(device, command):
    # Permits to make a cold, warm or a hot start reset
    if command == 'Cold RST':
        reset = b'\xB5\x62\x06\x04\x04\x00\xFF\xA1\x02\x00\xB0\x47'
        device.write(reset)
        find_message(device)
    if command == 'Warm RST':
        reset = b'\xB5\x62\x06\x04\x04\x00\x01\x00\x02\x00\x11\x6C'
        device.write(reset)
        find_message(device)
    if command == 'Hot RST':
        reset = b'\xB5\x62\x06\x04\x04\x00\x00\x00\x02\x00\x10\x68'
        device.write(reset)
        find_message(device)


def enable(device, command):
    # set ephemerides, ionosphere and pseudo range message available
    # ste all ubx, nmea messages enable
    if command == 'EPH':
        eph_on = b'\xB5\x62\x06\x01\x03\x00\x0B\x31\x01\x47\xC3'
        device.write(eph_on)
        find_message(device)
    if command == 'HUI':
        hui_on = b'\xB5\x62\x06\x01\x02\x00\x0B\x02\x16\x49'
        device.write(hui_on)
        find_message(device)
    if command == 'RAW':
        raw_on = b'\xB5\x62\x06\x01\x03\x00\x02\x10\x01\x1D\x66'
        device.write(raw_on)
        find_message(device)
    if command == 'NMEA':  # receive an ack when test
        # DTM   GBS    GGA    GLL    GRS    GSA    GST    GSV    RMC
        # VTG   ZDA    PUBX 00     PUBX 03    PUBX 04
        nmea_on = b'\xB5\x62\x06\x01\x03\x00\xF0\x0A\x01\x05\x24'\
                  b'\xB5\x62\x06\x01\x03\x00\xF0\x09\x01\x04\x22'\
                  b'\xB5\x62\x06\x01\x03\x00\xF0\x00\x01\xFB\x10'\
                  b'\xB5\x62\x06\x01\x03\x00\xF0\x01\x01\xFC\x12'\
                  b'\xB5\x62\x06\x01\x03\x00\xF0\x06\x01\x01\x1C'\
                  b'\xB5\x62\x06\x01\x03\x00\xF0\x02\x01\xFD\x14'\
                  b'\xB5\x62\x06\x01\x03\x00\xF0\x07\x01\x02\x1E'\
                  b'\xB5\x62\x06\x01\x03\x00\xF0\x03\x01\xFE\x16'\
                  b'\xB5\x62\x06\x01\x03\x00\xF0\x04\x01\xFF\x18'\
                  b'\xB5\x62\x06\x01\x03\x00\xF0\x05\x01\x00\x1A'\
                  b'\xB5\x62\x06\x01\x03\x00\xF0\x08\x01\x03\x20'\
                  b'\xB5\x62\x06\x01\x03\x00\xF1\x00\x01\xFC\x13'\
                  b'\xB5\x62\x06\x01\x03\x00\xF1\x03\x01\xFF\x19'\
                  b'\xB5\x62\x06\x01\x03\x00\xF1\x04\x01\x00\x1B'
        device.write(nmea_on)
        find_message(device)
    if command == 'UBX':
        ubx_on = b'\xB5\x62\x06\x01\x03\x00\x0B\x30\x01\x46\xC1'\
                 b'\xB5\x62\x06\x01\x03\x00\x0B\x50\x01\x66\x01'\
                 b'\xB5\x62\x06\x01\x03\x00\x0B\x32\x01\x48\xC5'\
                 b'\xB5\x62\x06\x01\x03\x00\x0B\x33\x01\x49\xC7'\
                 b'\xB5\x62\x06\x01\x03\x00\x0B\x31\x01\x47\xC3'\
                 b'\xB5\x62\x06\x01\x03\x00\x0B\x02\x01\x18\x65'\
                 b'\xB5\x62\x06\x01\x03\x00\x0B\x01\x01\x17\x63'\
                 b'\xB5\x62\x06\x01\x03\x00\x0B\x00\x01\x16\x61'\
                 b'\xB5\x62\x06\x01\x03\x00\x10\x15\x01\x30\x9A'\
                 b'\xB5\x62\x06\x01\x03\x00\x10\x02\x01\x1D\x74'\
                 b'\xB5\x62\x06\x01\x03\x00\x10\x10\x01\x2B\x90'\
                 b'\xB5\x62\x06\x01\x03\x00\x28\x00\x01\x33\xB8'\
                 b'\xB5\x62\x06\x01\x03\x00\x21\x0E\x01\x3A\xBF'\
                 b'\xB5\x62\x06\x01\x03\x00\x21\x08\x01\x34\xB3'\
                 b'\xB5\x62\x06\x01\x03\x00\x21\x0B\x01\x37\xB9'\
                 b'\xB5\x62\x06\x01\x03\x00\x21\x0F\x01\x3B\xC1'\
                 b'\xB5\x62\x06\x01\x03\x00\x21\x0D\x01\x39\xBD'\
                 b'\xB5\x62\x06\x01\x03\x00\x13\x80\x01\x9E\x79'\
                 b'\xB5\x62\x06\x01\x03\x00\x13\x21\x01\x3F\xBB'\
                 b'\xB5\x62\x06\x01\x03\x00\x0A\x05\x01\x1A\x68'\
                 b'\xB5\x62\x06\x01\x03\x00\x0A\x09\x01\x1E\x70'\
                 b'\xB5\x62\x06\x01\x03\x00\x0A\x0B\x01\x20\x74'\
                 b'\xB5\x62\x06\x01\x03\x00\x0A\x02\x01\x17\x62'\
                 b'\xB5\x62\x06\x01\x03\x00\x0A\x06\x01\x1B\x6A'\
                 b'\xB5\x62\x06\x01\x03\x00\x0A\x07\x01\x1C\x6C'\
                 b'\xB5\x62\x06\x01\x03\x00\x0A\x21\x01\x36\xA0'\
                 b'\xB5\x62\x06\x01\x03\x00\x0A\x2E\x01\x43\xBA'\
                 b'\xB5\x62\x06\x01\x03\x00\x0A\x08\x01\x1D\x6E'\
                 b'\xB5\x62\x06\x01\x03\x00\x01\x60\x01\x6C\x03'\
                 b'\xB5\x62\x06\x01\x03\x00\x01\x05\x01\x11\x4D'\
                 b'\xB5\x62\x06\x01\x03\x00\x01\x22\x01\x2E\x87'\
                 b'\xB5\x62\x06\x01\x03\x00\x01\x3A\x01\x46\xB7'\
                 b'\xB5\x62\x06\x01\x03\x00\x01\x31\x01\x3D\xA5'\
                 b'\xB5\x62\x06\x01\x03\x00\x01\x04\x01\x10\x4B'\
                 b'\xB5\x62\x06\x01\x03\x00\x01\x40\x01\x4C\xC3'\
                 b'\xB5\x62\x06\x01\x03\x00\x01\x61\x01\x6D\x05'\
                 b'\xB5\x62\x06\x01\x03\x00\x01\x39\x01\x45\xB5'\
                 b'\xB5\x62\x06\x01\x03\x00\x01\x09\x01\x15\x55'\
                 b'\xB5\x62\x06\x01\x03\x00\x01\x34\x01\x40\xAB'\
                 b'\xB5\x62\x06\x01\x03\x00\x01\x01\x01\x0D\x45'\
                 b'\xB5\x62\x06\x01\x03\x00\x01\x02\x01\x0E\x47'\
                 b'\xB5\x62\x06\x01\x03\x00\x01\x07\x01\x13\x51'\
                 b'\xB5\x62\x06\x01\x03\x00\x01\x3C\x01\x48\xBB'\
                 b'\xB5\x62\x06\x01\x03\x00\x01\x35\x01\x41\xAD'\
                 b'\xB5\x62\x06\x01\x03\x00\x01\x32\x01\x3E\xA7'\
                 b'\xB5\x62\x06\x01\x03\x00\x01\x06\x01\x12\x4F'\
                 b'\xB5\x62\x06\x01\x03\x00\x01\x03\x01\x0F\x49'\
                 b'\xB5\x62\x06\x01\x03\x00\x01\x3B\x01\x47\xB9'\
                 b'\xB5\x62\x06\x01\x03\x00\x01\x30\x01\x3C\xA3'\
                 b'\xB5\x62\x06\x01\x03\x00\x01\x24\x01\x30\x8B'\
                 b'\xB5\x62\x06\x01\x03\x00\x01\x25\x01\x31\x8D'\
                 b'\xB5\x62\x06\x01\x03\x00\x01\x23\x01\x2F\x89'\
                 b'\xB5\x62\x06\x01\x03\x00\x01\x20\x01\x2C\x83'\
                 b'\xB5\x62\x06\x01\x03\x00\x01\x26\x01\x32\x8F'\
                 b'\xB5\x62\x06\x01\x03\x00\x01\x21\x01\x2D\x85'\
                 b'\xB5\x62\x06\x01\x03\x00\x01\x11\x01\x1D\x65'\
                 b'\xB5\x62\x06\x01\x03\x00\x01\x12\x01\x1E\x67'\
                 b'\xB5\x62\x06\x01\x03\x00\x02\x30\x01\x3D\xA6'\
                 b'\xB5\x62\x06\x01\x03\x00\x02\x31\x01\x3E\xA8'\
                 b'\xB5\x62\x06\x01\x03\x00\x02\x61\x01\x6E\x08'\
                 b'\xB5\x62\x06\x01\x03\x00\x02\x14\x01\x21\x6E'\
                 b'\xB5\x62\x06\x01\x03\x00\x02\x10\x01\x1D\x66'\
                 b'\xB5\x62\x06\x01\x03\x00\x02\x15\x01\x22\x70'\
                 b'\xB5\x62\x06\x01\x03\x00\x02\x59\x01\x66\xF8'\
                 b'\xB5\x62\x06\x01\x03\x00\x02\x11\x01\x1E\x68'\
                 b'\xB5\x62\x06\x01\x03\x00\x02\x13\x01\x20\x6C'\
                 b'\xB5\x62\x06\x01\x03\x00\x02\x20\x01\x2D\x86'\
                 b'\xB5\x62\x06\x01\x03\x00\x27\x01\x01\x33\xB7'\
                 b'\xB5\x62\x06\x01\x03\x00\x27\x03\x01\x35\xBB'\
                 b'\xB5\x62\x06\x01\x03\x00\x0D\x11\x01\x29\x89'\
                 b'\xB5\x62\x06\x01\x03\x00\x0D\x16\x01\x2E\x93'\
                 b'\xB5\x62\x06\x01\x03\x00\x0D\x13\x01\x2B\x8D'\
                 b'\xB5\x62\x06\x01\x03\x00\x0D\x04\x01\x1C\x6F'\
                 b'\xB5\x62\x06\x01\x03\x00\x0D\x03\x01\x1B\x6D'\
                 b'\xB5\x62\x06\x01\x03\x00\x0D\x12\x01\x2A\x8B'\
                 b'\xB5\x62\x06\x01\x03\x00\x0D\x01\x01\x19\x69'\
                 b'\xB5\x62\x06\x01\x03\x00\x0D\x15\x01\x2D\x91'\
                 b'\xB5\x62\x06\x01\x03\x00\x0D\x06\x01\x1E\x73'\
                 b'\xB5\x62\x06\x01\x03\x00\x09\x14\x01\x28\x83'
        device.write(ubx_on)
        find_message(device)


def poll(device, command):
    # read ephemerides and ionosphere message
    if command == 'EPH':
        eph_get = b'\xB5\x62\x0B\x31\x00\x00\x3C\xBF'
        device.write(eph_get)
        find_message(device)
    if command == 'HUI':
        hui_get = b'\xB5\x62\x0B\x02\x00\x00\x0D\x32'
        device.write(hui_get)
        find_message(device)
    if command == 'RAW':
        raw_get = b'\xB5\x62\x02\x10\x00\x00\x12\x38'
        device.write(raw_get)
        find_message(device)


def disable(device, command):
    # disable UBX or NMEA message
    if command == 'UBX':  # Receive a Nac when test -- pb : UBX msg turn off by default
        disable = b'\xB5\x62\x06\x01\x03\x00\x0B\x30\x01\x45\xC0'\
                  b'\xB5\x62\x06\x01\x03\x00\x0B\x50\x00\x65\x00'\
                  b'\xB5\x62\x06\x01\x03\x00\x0B\x32\x00\x47\xC4'\
                  b'\xB5\x62\x06\x01\x03\x00\x0B\x33\x00\x48\xC6'\
                  b'\xB5\x62\x06\x01\x03\x00\x0B\x31\x00\x46\xC2'\
                  b'\xB5\x62\x06\x01\x03\x00\x0B\x02\x00\x17\x64'\
                  b'\xB5\x62\x06\x01\x03\x00\x0B\x01\x00\x16\x62'\
                  b'\xB5\x62\x06\x01\x03\x00\x0B\x00\x00\x15\x60'\
                  b'\xB5\x62\x06\x01\x03\x00\x10\x15\x00\x2F\x99'\
                  b'\xB5\x62\x06\x01\x03\x00\x10\x02\x00\x1C\x73'\
                  b'\xB5\x62\x06\x01\x03\x00\x10\x10\x00\x2A\x8F'\
                  b'\xB5\x62\x06\x01\x03\x00\x28\x00\x00\x32\xB7'\
                  b'\xB5\x62\x06\x01\x03\x00\x21\x0E\x00\x39\xBE'\
                  b'\xB5\x62\x06\x01\x03\x00\x21\x08\x00\x33\xB2'\
                  b'\xB5\x62\x06\x01\x03\x00\x21\x0B\x00\x36\xB8'\
                  b'\xB5\x62\x06\x01\x03\x00\x21\x0F\x00\x3A\xC0'\
                  b'\xB5\x62\x06\x01\x03\x00\x21\x0D\x00\x38\xBC'\
                  b'\xB5\x62\x06\x01\x03\x00\x13\x80\x00\x9D\x78'\
                  b'\xB5\x62\x06\x01\x03\x00\x13\x21\x00\x3E\xBA'\
                  b'\xB5\x62\x06\x01\x03\x00\x0A\x05\x00\x19\x67'\
                  b'\xB5\x62\x06\x01\x03\x00\x0A\x09\x00\x1D\x6F'\
                  b'\xB5\x62\x06\x01\x03\x00\x0A\x0B\x00\x1F\x73'\
                  b'\xB5\x62\x06\x01\x03\x00\x0A\x02\x00\x16\x61'\
                  b'\xB5\x62\x06\x01\x03\x00\x0A\x06\x00\x1A\x69'\
                  b'\xB5\x62\x06\x01\x03\x00\x0A\x07\x00\x1B\x6B'\
                  b'\xB5\x62\x06\x01\x03\x00\x0A\x21\x00\x35\x9F'\
                  b'\xB5\x62\x06\x01\x03\x00\x0A\x2E\x00\x42\xB9'\
                  b'\xB5\x62\x06\x01\x03\x00\x0A\x08\x00\x1C\x6D'\
                  b'\xB5\x62\x06\x01\x03\x00\x01\x60\x00\x6B\x02'\
                  b'\xB5\x62\x06\x01\x03\x00\x01\x05\x00\x10\x4C'\
                  b'\xB5\x62\x06\x01\x03\x00\x01\x22\x00\x2D\x86'\
                  b'\xB5\x62\x06\x01\x03\x00\x01\x3A\x00\x45\xB6'\
                  b'\xB5\x62\x06\x01\x03\x00\x01\x31\x00\x3C\xA4'\
                  b'\xB5\x62\x06\x01\x03\x00\x01\x04\x00\x0F\x4A'\
                  b'\xB5\x62\x06\x01\x03\x00\x01\x40\x00\x4B\xC2'\
                  b'\xB5\x62\x06\x01\x03\x00\x01\x61\x00\x6C\x04'\
                  b'\xB5\x62\x06\x01\x03\x00\x01\x39\x00\x44\xB4'\
                  b'\xB5\x62\x06\x01\x03\x00\x01\x09\x00\x14\x54'\
                  b'\xB5\x62\x06\x01\x03\x00\x01\x34\x00\x3F\xAA'\
                  b'\xB5\x62\x06\x01\x03\x00\x01\x01\x00\x0C\x44'\
                  b'\xB5\x62\x06\x01\x03\x00\x01\x02\x00\x0D\x46'\
                  b'\xB5\x62\x06\x01\x03\x00\x01\x07\x00\x12\x50'\
                  b'\xB5\x62\x06\x01\x03\x00\x01\x3C\x00\x47\xBA'\
                  b'\xB5\x62\x06\x01\x03\x00\x01\x35\x00\x40\xAC'\
                  b'\xB5\x62\x06\x01\x03\x00\x01\x32\x00\x3D\xA6'\
                  b'\xB5\x62\x06\x01\x03\x00\x01\x06\x00\x11\x4E'\
                  b'\xB5\x62\x06\x01\x03\x00\x01\x03\x00\x0E\x48'\
                  b'\xB5\x62\x06\x01\x03\x00\x01\x3B\x00\x46\xB8'\
                  b'\xB5\x62\x06\x01\x03\x00\x01\x30\x00\x3B\xA2'\
                  b'\xB5\x62\x06\x01\x03\x00\x01\x24\x00\x2F\x8A'\
                  b'\xB5\x62\x06\x01\x03\x00\x01\x25\x00\x30\x8C'\
                  b'\xB5\x62\x06\x01\x03\x00\x01\x23\x00\x2E\x88'\
                  b'\xB5\x62\x06\x01\x03\x00\x01\x20\x00\x2B\x82'\
                  b'\xB5\x62\x06\x01\x03\x00\x01\x26\x00\x31\x8E'\
                  b'\xB5\x62\x06\x01\x03\x00\x01\x21\x00\x2C\x84'\
                  b'\xB5\x62\x06\x01\x03\x00\x01\x11\x00\x1C\x64'\
                  b'\xB5\x62\x06\x01\x03\x00\x01\x12\x00\x1D\x66'\
                  b'\xB5\x62\x06\x01\x03\x00\x02\x30\x00\x3C\xA5'\
                  b'\xB5\x62\x06\x01\x03\x00\x02\x31\x00\x3D\xA7'\
                  b'\xB5\x62\x06\x01\x03\x00\x02\x61\x00\x6D\x07'\
                  b'\xB5\x62\x06\x01\x03\x00\x02\x14\x00\x20\x6D'\
                  b'\xB5\x62\x06\x01\x03\x00\x02\x10\x00\x1C\x65'\
                  b'\xB5\x62\x06\x01\x03\x00\x02\x15\x00\x21\x6F'\
                  b'\xB5\x62\x06\x01\x03\x00\x02\x59\x00\x65\xF7'\
                  b'\xB5\x62\x06\x01\x03\x00\x02\x11\x00\x1D\x67'\
                  b'\xB5\x62\x06\x01\x03\x00\x02\x13\x00\x1F\x6B'\
                  b'\xB5\x62\x06\x01\x03\x00\x02\x20\x00\x2C\x85'\
                  b'\xB5\x62\x06\x01\x03\x00\x27\x01\x00\x32\xB6'\
                  b'\xB5\x62\x06\x01\x03\x00\x27\x03\x00\x34\xBA'\
                  b'\xB5\x62\x06\x01\x03\x00\x0D\x11\x00\x28\x88'\
                  b'\xB5\x62\x06\x01\x03\x00\x0D\x16\x00\x2D\x92'\
                  b'\xB5\x62\x06\x01\x03\x00\x0D\x13\x00\x2A\x8C'\
                  b'\xB5\x62\x06\x01\x03\x00\x0D\x04\x00\x1B\x6E'\
                  b'\xB5\x62\x06\x01\x03\x00\x0D\x03\x00\x1A\x6C'\
                  b'\xB5\x62\x06\x01\x03\x00\x0D\x12\x00\x29\x8A'\
                  b'\xB5\x62\x06\x01\x03\x00\x0D\x01\x00\x18\x68'\
                  b'\xB5\x62\x06\x01\x03\x00\x0D\x15\x00\x2C\x90'\
                  b'\xB5\x62\x06\x01\x03\x00\x0D\x06\x00\x1D\x72'\
                  b'\xB5\x62\x06\x01\x03\x00\x09\x14\x00\x27\x82'
        device.write(disable)
        find_message(device)
    if command == 'NMEA':
        # DTM   GBS    GGA    GLL    GRS    GSA    GST    GSV    RMC
        # VTG   ZDA    PUBX 00     PUBX 03    PUBX 04
        disable = b'\xB5\x62\x06\x01\x03\x00\xF0\x0A\x00\x04\x23'\
                  b'\xB5\x62\x06\x01\x03\x00\xF0\x09\x00\x03\x21'\
                  b'\xB5\x62\x06\x01\x03\x00\xF0\x00\x00\xFA\x0F'\
                  b'\xB5\x62\x06\x01\x03\x00\xF0\x01\x00\xFB\x11'\
                  b'\xB5\x62\x06\x01\x03\x00\xF0\x06\x00\x00\x1B'\
                  b'\xB5\x62\x06\x01\x03\x00\xF0\x02\x00\xFC\x13'\
                  b'\xB5\x62\x06\x01\x03\x00\xF0\x07\x00\x01\x1D'\
                  b'\xB5\x62\x06\x01\x03\x00\xF0\x03\x00\xFD\x15'\
                  b'\xB5\x62\x06\x01\x03\x00\xF0\x04\x00\xFE\x17'\
                  b'\xB5\x62\x06\x01\x03\x00\xF0\x05\x00\xFF\x19'\
                  b'\xB5\x62\x06\x01\x03\x00\xF0\x08\x00\x02\x1F'\
                  b'\xB5\x62\x06\x01\x03\x00\xF1\x00\x00\xFB\x12'\
                  b'\xB5\x62\x06\x01\x03\x00\xF1\x03\x00\xFE\x18'\
                  b'\xB5\x62\x06\x01\x03\x00\xF1\x04\x00\xFF\x1A'
        device.write(disable)
        find_message(device)


def find_message(device):
    #
    msgsent = time.time()
    wait = 1
    while time.time() < wait + msgsent:
        line = device.readline()
        if line[0:4] == b'\xb5b\x05\x01':
            print('ack received')
        elif line[0:4] == b'\xb5b\x05\x00':
            print('nak received')


def read_data(device, savefile):
    for j in range(7):
        info = device.readline()
        savefile.write(info)


# def read_data(duration):
# read information of ublox and save them into a file
#    ser = connection.connect_ublox()
#    duree = tools.Tools.get_sec(duration)
#    savefile = open('ublox_data.nmea', 'wb')
#    i = 0
#    while i <= duree:
#        for j in range(7):  # la valeur du range depend du nb de msg GPGSV a modifier! ici pour # msg GPGSV
#            info = ser.readline()
#            savefile.write(info)
#        i += 1
#        print('ublox', i)
#    savefile.close()

# filename = 'ublox_data.nmea'

# done = tools.data('ublox_data.nmea')
# print(done)
